<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="sql-mapper">

    <!-- 공통조회 테스트 -->
    <select id="SELECT_TEST" resultType="java.util.HashMap">
        /*  SELECT_TEST_ORACLE  */

        SELECT *
        FROM   COMM
        <where>
            <if test="UNIVNO != null and UNIVNO != ''">
                AND UNIVNO = #{UNIVNO}
            </if>
            <if test="COMMNO != null and COMMNO != ''">
                AND COMMNO = #{COMMNO}
            </if>
            <if test="0 == 0">
                AND COMMNO = '00001'
            </if>
        </where>
    </select>

    <select id="SELECT_TEST_BIG_DATA" resultType="java.util.HashMap">
        /*  SELECT_TEST_BIG_DATA_ORACLE  */

        SELECT OA.*
        , GET_ASSET_REQUESTING_NAME( OA.UNIVNO, OA.CAMPUSNO, OA.ASSETNO ) REQ_NAME
        , GET_ASSETSTATE_NAME( OA.ASSETSTATE ) ASSETSTATENAME
        , FL.URL
        FROM   (
        SELECT    VAO.UNIVNO, VAO.CAMPUSNO, CAM.CAMPUSNAME, VAO.ASSETNO, VAO.ASSETNAME, VAO.MODELNAME, VAO.SPEC, VAO.PRICE, VAO.QTY, VAO.AMOUNT
        , VAO.DEPTNO, DT.DEPTNAME, VAO.MAEMPNO, EM.EMPNAME MAEMPNAME, VAO.EMPNO, EP.EMPNAME, VAO.RECORDDATE, VAO.SERIALNUM, VAO.BIGO, VAO.BUYCONAME
        , PD.PLACENO BUILDING, PD.PLACENAME BUILDINGNAME, VAO.PLACENO, PL.PLACENAME, VAO.ASSETSTATE, VAO.ASSETTYPE, CT.COMMNAME ASSETTYPENAME
        , GG.GUBUNNO GGUBUNNO, GG.GUBUNNAME GGUBUNNAME, GM.GUBUNNO MGUBUNNO, GM.GUBUNNAME MGUBUNNAME, VAO.GUBUNNO, GS.GUBUNNAME, VAO.NOMALGUBN
        , VAO.ASSETLIFE, VAO.USESTATE, VAO.DUDATE ,VAO.DEPRE_CALC_TYPE, VAO.MENO_PRICE, VAO.BUYREQNO, VAO.REQNAME, VAO.REQDATE
        , VAO.DEPREGUBN, (CASE WHEN VAO.DEPREGUBN = 0 THEN '상각(O)' ELSE '상각(X)' END) DEPREGUBNNAME, (CASE WHEN VAO.USESTATE = 0 THEN '정상' ELSE '불용' END) USESTATENAME
        , VAO.PRINTCNT, VAO.LABELSTATE, VAO.LABELDATE, SA.S_YEAR,SA.SURVEY_DATE, VAO.DOCCHECK, DQ.REQDISUSE
        , CEIL(SUM(VAO.AMOUNT) OVER()) AS SUM_AMOUNT , CEIL(SUM(VAO.QTY) OVER()) AS SUM_QTY
        , CEIL(ROW_NUMBER() OVER(ORDER BY VAO.UNIVNO, VAO.RECORDDATE DESC, VAO.ASSETNO DESC ) / 10000) AS PAGENUM
        , CEIL(COUNT(VAO.ASSETNO) OVER() / 10000)                                                      AS TOTALPAGE
        , CEIL(COUNT(VAO.ASSETNO) OVER() / 1 )                                                              AS TOTALROW
        FROM   ASSET_ONAMS VAO
        LEFT OUTER JOIN DEPT DT ON VAO.UNIVNO = DT.UNIVNO AND VAO.DEPTNO = DT.DEPTNO
        LEFT OUTER JOIN PLACE PL ON VAO.UNIVNO = PL.UNIVNO AND VAO.PLACENO = PL.PLACENO
        LEFT OUTER JOIN PLACE PD ON PL.UNIVNO = PD.UNIVNO AND PL.HIGHPLACE = PD.PLACENO
        LEFT OUTER JOIN EMP EM ON VAO.UNIVNO = EM.UNIVNO AND VAO.MAEMPNO = EM.EMPNO
        LEFT OUTER JOIN EMP EP ON VAO.UNIVNO = EP.UNIVNO AND VAO.EMPNO = EP.EMPNO
        LEFT OUTER JOIN CAMPUS CAM ON VAO.UNIVNO = CAM.UNIVNO AND VAO.CAMPUSNO = CAM.CAMPUSNO
        LEFT OUTER JOIN COMM CT ON VAO.UNIVNO = CT.UNIVNO AND VAO.ASSETTYPE = CT.COMMNO
        LEFT OUTER JOIN ASSET_GUBUN GS ON VAO.UNIVNO = GS.UNIVNO AND VAO.GUBUNNO = GS.GUBUNNO
        LEFT OUTER JOIN ASSET_GUBUN GM ON GS.UNIVNO = GM.UNIVNO AND GS.HIGHGUBUN = GM.GUBUNNO
        LEFT OUTER JOIN ASSET_GUBUN GG ON GM.UNIVNO = GG.UNIVNO AND GM.HIGHGUBUN = GG.GUBUNNO
        LEFT OUTER JOIN ( -- 재물조사 년도, 일자
        SELECT UNIVNO, CAMPUSNO, ASSETNO, MAX( SUBSTR(PLANNO, 0, 4) ) S_YEAR, TO_CHAR(MAX(WRITETIME),'yyyyMMdd') SURVEY_DATE
        FROM   (
        SELECT SA.UNIVNO, SA.CAMPUSNO, SA.PLANNO, SA.ASSETNO, SA.WRITETIME, NVL(SA.SURVEYASSETEXIST, 1) ISEXIST
        , ROW_NUMBER() OVER( PARTITION BY SA.PLANNO, SA.ASSETNO
        ORDER BY SA.PLANNO, SA.ASSETNO, SA.WRITETIME DESC ) RNUM
        FROM   SURVEY_ASSET SA, ASSET_ONAMS OA
        WHERE  SA.UNIVNO    = '0001'
        AND    SA.CAMPUSNO  = '01'
        AND    SA.DELYN = 0 AND SA.USEYN = 0
        AND    SA.UNIVNO = OA.UNIVNO AND SA.CAMPUSNO = OA.CAMPUSNO AND SA.ASSETNO = OA.ASSETNO
        )
        WHERE  RNUM IN (1,3)
        AND    ISEXIST = 0
        GROUP BY UNIVNO, CAMPUSNO, ASSETNO
        ) SA ON VAO.UNIVNO = SA.UNIVNO AND VAO.CAMPUSNO = SA.CAMPUSNO AND VAO.ASSETNO  = SA.ASSETNO
        LEFT OUTER JOIN (
        SELECT UNIVNO,CAMPUSNO,ASSETNO,'Y' REQDISUSE
        FROM ASSET_DISUSE
        WHERE UNIVNO = '0001'
        AND CAMPUSNO = '01'
        AND CONFSTATE = 0
        ) DQ ON VAO.UNIVNO = DQ.UNIVNO AND VAO.CAMPUSNO = DQ.CAMPUSNO AND VAO.ASSETNO = DQ.ASSETNO
        WHERE  VAO.UNIVNO   = '0001'
        AND    VAO.CAMPUSNO = '01'
        AND    VAO.USESTATE  <![CDATA[<]]>  9
        AND    VAO.ASSETTYPE = '00113'
        AND    VAO.USESTATE = 0
        ) OA
        LEFT OUTER JOIN (
        SELECT  UNIVNO, CAMPUSNO, TRIM(CATEGORYITEM) ASSETNO
        , '/files/' || UNIVNO || '/' || CAMPUSNO || '/' || MAX(CATEGORY) || '/' || MIN(NAMER) AS URL
        FROM FILELIST
        WHERE UNIVNO = '0001'
        AND CAMPUSNO = '01'
        AND CATEGORY = 'ASSET_IMAGES'
        AND DELYN = 0
        GROUP BY UNIVNO, CAMPUSNO, CATEGORYITEM
        ) FL ON OA.UNIVNO = FL.UNIVNO AND OA.CAMPUSNO = FL.CAMPUSNO AND OA.ASSETNO = FL.ASSETNO
        WHERE  ( 1 = 0 OR PAGENUM = 1 )
    </select>

</mapper>